<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>{{ title }}</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link href="https://unpkg.com/maplibre-gl@{{ maplibre_version }}/dist/maplibre-gl.css" rel="stylesheet" />
    {% if draw_control %}
    <link href="https://unpkg.com/@mapbox/mapbox-gl-draw@latest/dist/mapbox-gl-draw.css" rel="stylesheet" />
    {% endif %}
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            width: 100%;
            height: 500px;
            position: relative;
        }

        .maplibreum-legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 6px;
            font-size: 12px;
            border-radius: 4px;
        }

        .maplibreum-legend div {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }

        .maplibreum-legend span {
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 4px;

        }

        {{ custom_css | safe }}

    </style>
</head>
<body>
    <div id="map">
        {% for legend in legends %}
        <div class="maplibreum-legend">{{ legend | safe }}</div>
        {% endfor %}
    </div>
    <script src="https://unpkg.com/maplibre-gl@{{ maplibre_version }}/dist/maplibre-gl.js"></script>
    {% if draw_control %}
    <script src="https://unpkg.com/@mapbox/mapbox-gl-draw@latest/dist/mapbox-gl-draw.js"></script>
    {% endif %}
    <script>
        // Initialize map
        var map = new maplibregl.Map({{ map_options | tojson }});


// Add controls
{% for ctrl in controls %}
{% if ctrl.type == "navigation" %}
map.addControl(new maplibregl.NavigationControl(), "{{ ctrl.position }}");
{% elif ctrl.type == "scale" %}
map.addControl(new maplibregl.ScaleControl({{ ctrl.options | tojson }}), "{{ ctrl.position }}");
{% elif ctrl.type == "fullscreen" %}
map.addControl(new maplibregl.FullscreenControl(), "{{ ctrl.position }}");
{% elif ctrl.type == "geolocate" %}
map.addControl(new maplibregl.GeolocateControl({{ ctrl.options | tojson }}), "{{ ctrl.position }}");
{% elif ctrl.type == "attribution" %}
map.addControl(new maplibregl.AttributionControl({{ ctrl.options | tojson }}), "{{ ctrl.position }}");
{% endif %}
{% endfor %}

{% if draw_control %}
var draw = new MapboxDraw({{ draw_control_options | tojson }});
map.addControl(draw);
function updateDrawn() {
    var data = draw.getAll();
    if (window.Jupyter && Jupyter.notebook && Jupyter.notebook.kernel) {
        var cmd = "from maplibreum.core import Map; Map._store_drawn_features('" + "{{ map_id }}" + "', '" + JSON.stringify(data).replace(/'/g, "\\'") + "')";
        Jupyter.notebook.kernel.execute(cmd);
    }
}
map.on('draw.create', updateDrawn);
map.on('draw.update', updateDrawn);
map.on('draw.delete', updateDrawn);
{% endif %}

map.on('load', function() {
    {% if bounds %}
    map.fitBounds({{ bounds | tojson }}{% if bounds_padding is not none %}, {padding: {{ bounds_padding | tojson }}}{% endif %});
    {% endif %}
    // Add sources
    {% for source in sources %}
    map.addSource("{{ source.name }}", {{ source.definition | tojson | safe }});
    {% endfor %}

    // Add layers
    {% for layer in layers %}
    map.addLayer({{ layer.definition | tojson | safe }}{% if layer.before %}, "{{ layer.before }}"{% endif %});
    {% endfor %}

    // Popups
    {% for popup in popups %}
    var popup_{{ loop.index }} = new maplibregl.Popup({{ popup.options | tojson }}).setHTML(`{{ popup.html }}`);
    {% if popup.coordinates %}
    popup_{{ loop.index }}.setLngLat({{ popup.coordinates | tojson }}).addTo(map);
    {% endif %}
    {% if popup.layer_id and popup.events %}
    map.on('{{ popup.events|first }}', '{{ popup.layer_id }}', function(e) {
        popup_{{ loop.index }}
            .setLngLat(e.lngLat)
            .setHTML(`{{ popup.html }}`)
            .addTo(map);
    });
    {% endif %}
    {% endfor %}

    // Tooltips
    {% for tooltip in tooltips %}
    var tooltip_{{ loop.index }} = new maplibregl.Popup({{ tooltip.options | tojson }});
    map.on('mouseenter', '{{ tooltip.layer_id }}', function(e) {
        tooltip_{{ loop.index }}
            .setLngLat(e.lngLat)
            .setHTML(`{{ tooltip.text }}`)
            .addTo(map);
    });
    map.on('mouseleave', '{{ tooltip.layer_id }}', function() {
        tooltip_{{ loop.index }}.remove();
    });
    {% endfor %}

    // Tile Layers
    var tileLayers = [
    {% for tile in tile_layers %}
        { id: "{{ tile.id }}", name: "{{ tile.name }}" },
    {% endfor %}
    ];

    // Overlay Layers
    var overlayLayers = [
    {% for ov in overlays %}
        { id: "{{ ov.id }}", name: "{{ ov.name }}"{% if ov.layers %}, layers: [{% for lid in ov.layers %}"{{ lid }}"{% if not loop.last %}, {% endif %}{% endfor %}]{% endif %} },
    {% endfor %}
    ];

    {% if tile_layers %}
    // Hide all but the first tile layer
    tileLayers.forEach(function(tl, idx) {
        map.setLayoutProperty(tl.id, 'visibility', idx === 0 ? 'visible' : 'none');
    });
    {% endif %}

    {% if layer_control %}
    // Simple layer control
    var layerControl = document.createElement('div');
    layerControl.id = 'layer-control';
    tileLayers.forEach(function(tl) {
        var link = document.createElement('a');
        link.href = '#';
        link.textContent = tl.name;
        link.addEventListener('click', function(e) {
            e.preventDefault();
            tileLayers.forEach(function(other) {
                map.setLayoutProperty(other.id, 'visibility', other.id === tl.id ? 'visible' : 'none');
            });
        });
        layerControl.appendChild(link);
    });

    overlayLayers.forEach(function(ol) {
        var label = document.createElement('label');
        var checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = true;
        checkbox.addEventListener('change', function(e) {
            if (ol.layers) {
                ol.layers.forEach(function(id) {
                    map.setLayoutProperty(id, 'visibility', e.target.checked ? 'visible' : 'none');
                });
            } else {
                map.setLayoutProperty(ol.id, 'visibility', e.target.checked ? 'visible' : 'none');
            }
        });
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(' ' + ol.name));
        layerControl.appendChild(label);
    });
    map.getContainer().appendChild(layerControl);
    {% endif %}

    // Markers
    {% for marker in markers %}
    var marker_{{ marker.id }} = new maplibregl.Marker({{ {'color': marker.color, 'draggable': marker.draggable} | tojson | safe }})
        .setLngLat({{ marker.coordinates | tojson }})
        .addTo(map);
    {% if marker.popup %}
    marker_{{ marker.id }}.setPopup(new maplibregl.Popup().setHTML(`{{ marker.popup }}`));
    {% endif %}
    {% if marker.tooltip %}
    var tooltip_{{ marker.id }} = new maplibregl.Popup({closeButton: false});
    marker_{{ marker.id }}.getElement().addEventListener('mouseenter', function() {
        tooltip_{{ marker.id }}
            .setLngLat(marker_{{ marker.id }}.getLngLat())
            .setHTML(`{{ marker.tooltip }}`)
            .addTo(map);
    });
    marker_{{ marker.id }}.getElement().addEventListener('mouseleave', function() {
        tooltip_{{ marker.id }}.remove();
    });
    {% endif %}
    {% if marker.draggable %}
    marker_{{ marker.id }}.on('dragend', function() {
        var lngLat = marker_{{ marker.id }}.getLngLat();
        if (window.Jupyter && Jupyter.notebook && Jupyter.notebook.kernel) {
            var cmd = "from maplibreum.core import Map; Map._update_marker_coords('" + "{{ map_id }}" + "', '" + "{{ marker.id }}" + "', " + lngLat.lng + ", " + lngLat.lat + ")";
            Jupyter.notebook.kernel.execute(cmd);
        }
    });
    {% endif %}
    {% endfor %}

    {% for cl in cluster_layers %}
    map.on('click', '{{ cl.cluster_layer }}', function(e) {
        var features = map.queryRenderedFeatures(e.point, { layers: ['{{ cl.cluster_layer }}'] });
        var clusterId = features[0].properties.cluster_id;
        map.getSource('{{ cl.source }}').getClusterExpansionZoom(clusterId, function(err, zoom) {
            if (err) return;
            map.easeTo({ center: features[0].geometry.coordinates, zoom: zoom });
        });
    });
    map.on('mouseenter', '{{ cl.cluster_layer }}', function() {
        map.getCanvas().style.cursor = 'pointer';
    });
    map.on('mouseleave', '{{ cl.cluster_layer }}', function() {
        map.getCanvas().style.cursor = '';
    });
    {% endfor %}
});

    {% if lat_lng_popup %}
    map.on('click', function(e) {
        new maplibregl.Popup()
            .setLngLat(e.lngLat)
            .setHTML('Lat: ' + e.lngLat.lat.toFixed(5) + '<br>Lng: ' + e.lngLat.lng.toFixed(5))
            .addTo(map);
    });
    {% endif %}

    {{ extra_js | safe }}
    </script>
</body>

</html>
