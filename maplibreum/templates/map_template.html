<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>{{ title }}</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link href="https://unpkg.com/maplibre-gl@{{ maplibre_version }}/dist/maplibre-gl.css" rel="stylesheet" onerror="this.onerror=null;this.href='https://cdn.jsdelivr.net/npm/maplibre-gl@{{ maplibre_version }}/dist/maplibre-gl.css';" />
    {% if draw_control or measure_control %}
    <link href="https://unpkg.com/@mapbox/mapbox-gl-draw@latest/dist/mapbox-gl-draw.css" rel="stylesheet" onerror="console.warn('Failed to load draw control CSS')" />
    {% endif %}
    {% if include_minimap %}
    <link href="https://unpkg.com/maplibregl-minimap/dist/minimap-control.css" rel="stylesheet" onerror="console.warn('Failed to load minimap CSS')" />
    {% endif %}
    {% if include_search %}
    <link href="https://unpkg.com/@maplibre/maplibre-gl-geocoder@latest/dist/maplibre-gl-geocoder.css" rel="stylesheet" onerror="console.warn('Failed to load geocoder CSS')" />
    {% endif %}
    {% if time_dimension %}
    <link href="https://cdn.jsdelivr.net/npm/leaflet-timedimension@1.1.0/dist/leaflet.timedimension.control.min.css" rel="stylesheet" onerror="console.warn('Failed to load time dimension CSS')" />
    {% endif %}
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #{{ map_id }} {
            width: 100%;
            height: 500px;
            position: relative;
        }

        .maplibreum-legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 6px;
            font-size: 12px;
            border-radius: 4px;
        }

        .maplibreum-legend div {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }

        .maplibreum-legend span {
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 4px;

        }

        {{ custom_css | safe }}

    </style>
    {% for script in external_scripts %}
    <script src="{{ script.src }}"{% for attr, value in script.attributes.items() %}{% if value is sameas(true) %} {{ attr }}{% else %} {{ attr }}="{{ value }}"{% endif %}{% endfor %}></script>
    {% endfor %}
</head>
<body>
    <div id="{{ map_id }}">
        {% for image in float_images %}
        <img src="{{ image.image_url }}" style="position: absolute; {{ image.style }} z-index: 999;">
        {% endfor %}
        {% for legend in legends %}
        <div class="maplibreum-legend">{{ legend | safe }}</div>
        {% endfor %}
    </div>
    <!-- MapLibre GL JS with CDN fallbacks -->
    <script>
        // Function to load MapLibre GL JS with fallbacks
        function loadMapLibreGL() {
            return new Promise((resolve, reject) => {
                // Try loading from unpkg.com first
                const script1 = document.createElement('script');
                script1.src = 'https://unpkg.com/maplibre-gl@{{ maplibre_version }}/dist/maplibre-gl.js';
                script1.onload = () => resolve();
                script1.onerror = () => {
                    // Fallback to jsDelivr
                    const script2 = document.createElement('script');
                    script2.src = 'https://cdn.jsdelivr.net/npm/maplibre-gl@{{ maplibre_version }}/dist/maplibre-gl.js';
                    script2.onload = () => resolve();
                    script2.onerror = () => {
                        // Last fallback to cdnjs
                        const script3 = document.createElement('script');
                        script3.src = 'https://cdnjs.cloudflare.com/ajax/libs/maplibre-gl/{{ maplibre_version }}/maplibre-gl.min.js';
                        script3.onload = () => resolve();
                        script3.onerror = () => reject(new Error('Failed to load MapLibre GL JS from all CDNs'));
                        document.head.appendChild(script3);
                    };
                    document.head.appendChild(script2);
                };
                document.head.appendChild(script1);
            });
        }

        // Function to show error message when MapLibre fails to load
        function showMapError(message) {
            const mapDiv = document.getElementById('{{ map_id }}');
            if (mapDiv) {
                mapDiv.innerHTML = `
                    <div style="
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        height: 100%;
                        background-color: #f8f9fa;
                        border: 2px dashed #dee2e6;
                        border-radius: 8px;
                        text-align: center;
                        padding: 20px;
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
                    ">
                        <div>
                            <div style="font-size: 48px; color: #6c757d; margin-bottom: 16px;">üó∫Ô∏è</div>
                            <div style="font-size: 18px; color: #495057; margin-bottom: 8px;">Map Loading Error</div>
                            <div style="font-size: 14px; color: #6c757d; margin-bottom: 16px;">${message}</div>
                            <div style="font-size: 12px; color: #6c757d;">
                                This may be due to network restrictions or CDN availability issues.
                                <br>Try refreshing the page or check your internet connection.
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Load MapLibre and initialize map
        loadMapLibreGL().then(() => {
            // MapLibre loaded successfully, check if it's available
            if (typeof maplibregl === 'undefined') {
                throw new Error('MapLibre GL JS loaded but not available');
            }
            {% if rtl_text_plugin %}
            try {
                var rtlStatus = typeof maplibregl.getRTLTextPluginStatus === 'function'
                    ? maplibregl.getRTLTextPluginStatus()
                    : 'unavailable';
                if ({{ 'true' if rtl_text_plugin.force else 'false' }} || rtlStatus !== 'loaded') {
                    var rtlPluginUrl = {{ rtl_text_plugin.url | tojson }};
                    {% if rtl_text_plugin.lazy %}
                    maplibregl.setRTLTextPlugin(
                        rtlPluginUrl,
                        {% if rtl_text_plugin.callback is defined %}{% if rtl_text_plugin.callback is none %}null{% else %}{{ rtl_text_plugin.callback | safe }}{% endif %}{% else %}null{% endif %},
                        true
                    );
                    {% elif rtl_text_plugin.callback is defined %}
                    maplibregl.setRTLTextPlugin(
                        rtlPluginUrl,
                        {% if rtl_text_plugin.callback is none %}null{% else %}{{ rtl_text_plugin.callback | safe }}{% endif %}
                    );
                    {% else %}
                    maplibregl.setRTLTextPlugin(rtlPluginUrl);
                    {% endif %}
                }
            } catch (rtlError) {
                console.warn('Failed to configure RTL text plugin', rtlError);
            }
            {% endif %}
            initializeMap();
        }).catch(error => {
            console.error('Failed to load MapLibre GL JS:', error);
            showMapError('Failed to load MapLibre GL JavaScript library');
        });

        function initializeMap() {
            try {
        // Initialize map
        var map = new maplibregl.Map({{ map_options | tojson | safe }});
        window.maplibreumMaps = window.maplibreumMaps || {};
        window.maplibreumMaps["{{ map_id }}"] = map;
        window.maplibreumMapsLoaded = window.maplibreumMapsLoaded || {};
        map.once('load', function() {
            window.maplibreumMapsLoaded["{{ map_id }}"] = true;
        });


// Add controls
{% for ctrl in controls %}
{% if ctrl.type == "navigation" %}
map.addControl(new maplibregl.NavigationControl({{ ctrl.options | tojson }}), "{{ ctrl.position }}");
{% elif ctrl.type == "scale" %}
map.addControl(new maplibregl.ScaleControl({{ ctrl.options | tojson }}), "{{ ctrl.position }}");
{% elif ctrl.type == "fullscreen" %}
map.addControl(new maplibregl.FullscreenControl(), "{{ ctrl.position }}");
{% elif ctrl.type == "geolocate" %}
map.addControl(new maplibregl.GeolocateControl({{ ctrl.options | tojson }}), "{{ ctrl.position }}");
{% elif ctrl.type == "attribution" %}
map.addControl(new maplibregl.AttributionControl({{ ctrl.options | tojson }}), "{{ ctrl.position }}");
{% elif ctrl.type == "minimap" %}
map.addControl(new MinimapControl({{ ctrl.options | tojson }}), "{{ ctrl.position }}");
{% elif ctrl.type == "search" %}
var geocoder = new MaplibreGeocoder(Object.assign({ maplibregl: maplibregl }, {{ ctrl.options | tojson }}));
geocoder.on('result', function(e) {
    var coords = e.result.geometry.coordinates;
    if (window.Jupyter && Jupyter.notebook && Jupyter.notebook.kernel) {
        var cmd = "from maplibreum.core import Map; Map._store_search_result('" + "{{ map_id }}" + "', " + coords[0] + ", " + coords[1] + ")";
        Jupyter.notebook.kernel.execute(cmd);
    }
});
map.addControl(geocoder, "{{ ctrl.position }}");
{% elif ctrl.type == "terrain" %}
map.addControl(new maplibregl.TerrainControl({{ ctrl.options | tojson }}), "{{ ctrl.position }}");
{% elif ctrl.type == "globe" %}
map.addControl(new maplibregl.GlobeControl({{ ctrl.options | tojson }}), "{{ ctrl.position }}");
{% endif %}
{% endfor %}

{% if draw_control %}
var draw = new MapboxDraw({{ draw_control_options | tojson }});
map.addControl(draw);
function updateDrawn() {
    var data = draw.getAll();
    if (window.Jupyter && Jupyter.notebook && Jupyter.notebook.kernel) {
        var cmd = "from maplibreum.core import Map; Map._store_drawn_features('" + "{{ map_id }}" + "', '" + JSON.stringify(data).replace(/'/g, "\\'") + "')";
        Jupyter.notebook.kernel.execute(cmd);
    }
}
map.on('draw.create', updateDrawn);
map.on('draw.update', updateDrawn);
map.on('draw.delete', updateDrawn);
{% endif %}

{% if measure_control %}
function _storeMeasure(data) {
    if (window.Jupyter && Jupyter.notebook && Jupyter.notebook.kernel) {
        var cmd = "from maplibreum.core import Map; Map._store_drawn_features('" + "{{ map_id }}" + "', '" + JSON.stringify(data).replace(/'/g, "\\'") + "')";
        Jupyter.notebook.kernel.execute(cmd);
    }
}
var measure = new maplibreGLMeasures(Object.assign({{ measure_control_options | tojson }}, {onCreate: _storeMeasure, onRender: _storeMeasure}));
map.addControl(measure, '{{ measure_control_position }}');
{% endif %}

map.on('load', function() {
    {% if bounds %}
    map.fitBounds({{ bounds | tojson }}{% if bounds_padding is not none %}, {padding: {{ bounds_padding | tojson }}}{% endif %});
    {% endif %}
    // Add sources
    {% for source in sources %}
    map.addSource("{{ source.name }}", {{ source.definition | tojson | safe }});
    {% endfor %}

    // Register images used by style layers
    {% for image in images %}
    {% if image.url %}
    map.loadImage({{ image.url | tojson }}).then(function(loadedImage) {
        map.addImage({{ image.id | tojson }}, loadedImage.data{% if image.options %}, {{ image.options | tojson | safe }}{% endif %});
    }).catch(function(err) {
        console.error('Failed to load image {{ image.id }}', err);
    });
    {% else %}
    map.addImage({{ image.id | tojson }}, {{ image.data | tojson | safe }}{% if image.options %}, {{ image.options | tojson | safe }}{% endif %});
    {% endif %}
    {% endfor %}

    {% if terrain %}
    map.setTerrain({{ terrain | tojson | safe }});
    {% endif %}
    {% if fog is not none %}
    map.setFog({{ fog | tojson | safe }});
    {% endif %}

    // Add layers
    {% for layer in layers %}
    map.addLayer({{ layer.definition | tojson | safe }}{% if layer.before %}, "{{ layer.before }}"{% endif %});
    {% endfor %}

    // Popups
    {% for popup in popups %}
    var popup_{{ loop.index }} = new maplibregl.Popup({{ popup.options | tojson }});
    {% if popup.html %}
    popup_{{ loop.index }}.setHTML(`{{ popup.html | safe }}`);
    {% endif %}
    {% if popup.coordinates %}
    popup_{{ loop.index }}.setLngLat({{ popup.coordinates | tojson }}).addTo(map);
    {% endif %}
    {% if popup.layer_id and popup.events %}
    map.on('{{ popup.events|first }}', '{{ popup.layer_id }}', function(e) {
        popup_{{ loop.index }}
            .setLngLat(e.lngLat)
            {% if popup.prop %}.setHTML(e.features[0].properties['{{ popup.prop }}']){% else %}.setHTML(`{{ popup.html | safe }}`){% endif %}
            .addTo(map);
    });
    {% endif %}
    {% endfor %}

    // Tooltips
    {% for tooltip in tooltips %}
    var tooltip_{{ loop.index }} = new maplibregl.Popup({{ tooltip.options | tojson }});
    map.on('mouseenter', '{{ tooltip.layer_id }}', function(e) {
        tooltip_{{ loop.index }}
            .setLngLat(e.lngLat)
            {% if tooltip.prop %}.setHTML(e.features[0].properties['{{ tooltip.prop }}']){% else %}.setHTML(`{{ tooltip.text }}`){% endif %}
            .addTo(map);
    });
    map.on('mouseleave', '{{ tooltip.layer_id }}', function() {
        tooltip_{{ loop.index }}.remove();
    });
    {% endfor %}

    // Tile Layers
    var tileLayers = [
    {% for tile in tile_layers %}
        { id: "{{ tile.id }}", name: "{{ tile.name }}" },
    {% endfor %}
    ];

    // Overlay Layers
    var overlayLayers = [
    {% for ov in overlays %}
        { id: "{{ ov.id }}", name: "{{ ov.name }}"{% if ov.layers %}, layers: [{% for lid in ov.layers %}"{{ lid }}"{% if not loop.last %}, {% endif %}{% endfor %}]{% endif %} },
    {% endfor %}
    ];

    {% if tile_layers %}
    // Hide all but the first tile layer
    tileLayers.forEach(function(tl, idx) {
        map.setLayoutProperty(tl.id, 'visibility', idx === 0 ? 'visible' : 'none');
    });
    {% endif %}

    {% if layer_control %}
    // Simple layer control
    var layerControl = document.createElement('div');
    layerControl.id = 'layer-control';
    tileLayers.forEach(function(tl) {
        var link = document.createElement('a');
        link.href = '#';
        link.textContent = tl.name;
        link.addEventListener('click', function(e) {
            e.preventDefault();
            tileLayers.forEach(function(other) {
                map.setLayoutProperty(other.id, 'visibility', other.id === tl.id ? 'visible' : 'none');
            });
        });
        layerControl.appendChild(link);
    });

    overlayLayers.forEach(function(ol) {
        var label = document.createElement('label');
        var checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = true;
        checkbox.addEventListener('change', function(e) {
            if (ol.layers) {
                ol.layers.forEach(function(id) {
                    map.setLayoutProperty(id, 'visibility', e.target.checked ? 'visible' : 'none');
                });
            } else {
                map.setLayoutProperty(ol.id, 'visibility', e.target.checked ? 'visible' : 'none');
            }
        });
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(' ' + ol.name));
        layerControl.appendChild(label);
    });
    map.getContainer().appendChild(layerControl);
    {% endif %}

    // Markers
    {% for marker in markers %}
    {% if marker.html is defined or marker.class_name is defined %}
    var el_{{ marker.id }} = document.createElement('div');
    el_{{ marker.id }}.className = "{{ marker.class_name }}";
    el_{{ marker.id }}.innerHTML = `{{ marker.html | safe }}`;
    var marker_{{ marker.id }} = new maplibregl.Marker({ element: el_{{ marker.id }}{% if marker.draggable %}, draggable: true{% endif %} })
        .setLngLat({{ marker.coordinates | tojson }})
        .addTo(map);
    {% else %}
    var marker_{{ marker.id }} = new maplibregl.Marker({{ {'color': marker.color, 'draggable': marker.draggable} | tojson | safe }})
        .setLngLat({{ marker.coordinates | tojson }})
        .addTo(map);
    {% endif %}
    {% if marker.popup %}
    marker_{{ marker.id }}.setPopup(new maplibregl.Popup().setHTML(`{{ marker.popup }}`));
    {% endif %}
    {% if marker.tooltip %}
    var tooltip_{{ marker.id }} = new maplibregl.Popup({closeButton: false});
    marker_{{ marker.id }}.getElement().addEventListener('mouseenter', function() {
        tooltip_{{ marker.id }}
            .setLngLat(marker_{{ marker.id }}.getLngLat())
            .setHTML(`{{ marker.tooltip }}`)
            .addTo(map);
    });
    marker_{{ marker.id }}.getElement().addEventListener('mouseleave', function() {
        tooltip_{{ marker.id }}.remove();
    });
    {% endif %}
    {% if marker.draggable %}
    marker_{{ marker.id }}.on('dragend', function() {
        var lngLat = marker_{{ marker.id }}.getLngLat();
        if (window.Jupyter && Jupyter.notebook && Jupyter.notebook.kernel) {
            var cmd = "from maplibreum.core import Map; Map._update_marker_coords('" + "{{ map_id }}" + "', '" + "{{ marker.id }}" + "', " + lngLat.lng + ", " + lngLat.lat + ")";
            Jupyter.notebook.kernel.execute(cmd);
        }
    });
    {% endif %}
    {% endfor %}

    {% for cl in cluster_layers %}
    map.on('click', '{{ cl.cluster_layer }}', function(e) {
        var features = map.queryRenderedFeatures(e.point, { layers: ['{{ cl.cluster_layer }}'] });
        var clusterId = features[0].properties.cluster_id;
        map.getSource('{{ cl.source }}').getClusterExpansionZoom(clusterId, function(err, zoom) {
            if (err) return;
            map.easeTo({ center: features[0].geometry.coordinates, zoom: zoom });
        });
    });
    map.on('mouseenter', '{{ cl.cluster_layer }}', function() {
        map.getCanvas().style.cursor = 'pointer';
    });
    map.on('mouseleave', '{{ cl.cluster_layer }}', function() {
        map.getCanvas().style.cursor = '';
    });
    {% endfor %}

    {% if time_dimension %}
    var tdData = {{ time_dimension_data | tojson | safe }};
    map.addSource('timedimension', {type: 'geojson', data: tdData});
    map.addLayer({
        id: 'timedimension',
        type: 'circle',
        source: 'timedimension',
        paint: { 'circle-radius': 5, 'circle-color': '#ff0000' }
    });
    var tdTimes = tdData.features.map(function(f){ return f.properties.time; }).sort();
    var tdIndex = 0;
    function tdStep(){
        var t = tdTimes[tdIndex];
        map.setFilter('timedimension', ['==', ['get','time'], t]);
        tdIndex = (tdIndex + 1) % tdTimes.length;
    }
    tdStep();
    setInterval(tdStep, {{ time_dimension_options.interval | default(1000) }});
    {% endif %}

    {% for callback in on_load_callbacks %}
    (function(map) {
        {{ callback | safe }}
    })(map);
    {% endfor %}

    {% for animation in animations %}
    (function(map) {
        {{ animation | safe }}
    })(map);
    {% endfor %}

    // Queued camera actions
    {% for action in camera_actions %}
    {% if action.method == 'panTo' %}
    map.panTo({{ action.center | tojson }}, {{ action.options | tojson }});
    {% else %}
    map.{{ action.method }}({{ action.options | tojson }});
    {% endif %}
    {% endfor %}
});

    {% for binding in event_bindings %}
    (function() {
        var handler = function(e) {
            var data = {};
            if (e.lngLat) { data.lngLat = e.lngLat; }
            if (e.features) { data.features = e.features; }
            if (e.point) { data.point = e.point; }
            data.center = map.getCenter();
            data.zoom = map.getZoom();
            {% if binding.send_to_python %}
            if (window.Jupyter && Jupyter.notebook && Jupyter.notebook.kernel) {
                var cmd = "from maplibreum.core import Map; Map._handle_event('" + "{{ map_id }}" + "', '" + "{{ binding.id }}" + "', '" + JSON.stringify(data).replace(/'/g, "\\'") + "')";
                Jupyter.notebook.kernel.execute(cmd);
            }
            {% endif %}
            {% if binding.state_toggles %}
            (function() {
                var toggles = {{ binding.state_toggles | tojson | safe }};
                toggles.forEach(function(tgl) {
                    var target = tgl.selector ? document.querySelector(tgl.selector) : null;
                    if (!target) { return; }
                    if (tgl.className) {
                        if (tgl.state === true) {
                            target.classList.add(tgl.className);
                        } else if (tgl.state === false) {
                            target.classList.remove(tgl.className);
                        } else {
                            target.classList.toggle(tgl.className);
                        }
                    }
                    if (tgl.attribute) {
                        var hasValue = Object.prototype.hasOwnProperty.call(tgl, 'value');
                        if (tgl.state === false && !hasValue) {
                            target.removeAttribute(tgl.attribute);
                        } else {
                            var attrValue = hasValue ? tgl.value : '';
                            target.setAttribute(tgl.attribute, String(attrValue));
                        }
                    }
                    if (tgl.dataset) {
                        Object.keys(tgl.dataset).forEach(function(key) {
                            target.dataset[key] = String(tgl.dataset[key]);
                        });
                    }
                    if (Object.prototype.hasOwnProperty.call(tgl, 'text')) {
                        target.textContent = String(tgl.text);
                    }
                });
            })();
            {% endif %}
            {% if binding.js %}
            (function(map, event, data) {
                {{ binding.js | safe }}
            })(map, e, data);
            {% endif %}
            {% if binding.once %}
            map.off('{{ binding.event }}'{% if binding.layer_id %}, '{{ binding.layer_id }}'{% endif %}, handler);
            {% endif %}
        };
        map.on('{{ binding.event }}'{% if binding.layer_id %}, '{{ binding.layer_id }}'{% endif %}, handler);
    })();
    {% endfor %}

    {% if lat_lng_popup %}
    map.on('click', function(e) {
        new maplibregl.Popup()
            .setLngLat(e.lngLat)
            .setHTML('Lat: ' + e.lngLat.lat.toFixed(5) + '<br>Lng: ' + e.lngLat.lng.toFixed(5))
            .addTo(map);
    });
    {% endif %}

    {{ extra_js | safe }}

            } catch (error) {
                console.error('Error initializing map:', error);
                showMapError('Error initializing the map: ' + error.message);
            }
        }
    </script>
    
    <!-- Load additional libraries with fallbacks -->
    {% if include_minimap %}
    <script src="https://unpkg.com/maplibregl-minimap/dist/minimap-control.js" onerror="console.warn('Failed to load minimap control')"></script>
    {% endif %}
    {% if draw_control %}
    <script src="https://unpkg.com/@mapbox/mapbox-gl-draw@latest/dist/mapbox-gl-draw.js" onerror="console.warn('Failed to load draw control')"></script>
    {% endif %}
    {% if measure_control %}
    <script src="https://unpkg.com/maplibre-gl-measures@latest/dist/maplibre-gl-measures.js" onerror="console.warn('Failed to load measure control')"></script>
    {% endif %}
    {% if time_dimension %}
    <script src="https://cdn.jsdelivr.net/npm/leaflet-timedimension@1.1.0/dist/leaflet.timedimension.min.js" onerror="console.warn('Failed to load time dimension')"></script>
    {% endif %}
    {% if include_search %}
    <script src="https://unpkg.com/@maplibre/maplibre-gl-geocoder@latest/dist/maplibre-gl-geocoder.js" onerror="console.warn('Failed to load geocoder')"></script>
    {% endif %}
</body>

</html>
