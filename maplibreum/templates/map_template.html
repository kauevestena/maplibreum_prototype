<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>{{ title }}</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            width: 100%;
            height: 500px;
        }

        {{ custom_css | safe }}

    </style>
</head>
<body>
    <div id="map"></div>
    <script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>
    <script>
        // Initialize map
        var map = new maplibregl.Map({
            container: 'map',
            style: {{ map_style | tojson }},
            center: {{ center | tojson }},
            zoom: {{ zoom }}
        });


// Add controls
{% for ctrl in controls %}
{% if ctrl.type == "navigation" %}
map.addControl(new maplibregl.NavigationControl(), "{{ ctrl.position }}");
{% elif ctrl.type == "scale" %}
map.addControl(new maplibregl.ScaleControl({{ ctrl.options | tojson }}), "{{ ctrl.position }}");
{% elif ctrl.type == "fullscreen" %}
map.addControl(new maplibregl.FullscreenControl(), "{{ ctrl.position }}");
{% endif %}
{% endfor %}

map.on('load', function() {
    // Add sources
    {% for source in sources %}
    map.addSource("{{ source.name }}", {{ source.definition | tojson | safe }});
    {% endfor %}

    // Add layers
    {% for layer in layers %}
    map.addLayer({{ layer.definition | tojson | safe }}{% if layer.before %}, "{{ layer.before }}"{% endif %});
    {% endfor %}

    // Popups
    {% for popup in popups %}
    var popup_{{ loop.index }} = new maplibregl.Popup({{ popup.options | tojson }}).setHTML(`{{ popup.html }}`);
    {% if popup.coordinates %}
    popup_{{ loop.index }}.setLngLat({{ popup.coordinates | tojson }}).addTo(map);
    {% endif %}
    {% if popup.layer_id and popup.events %}
    map.on('{{ popup.events|first }}', '{{ popup.layer_id }}', function(e) {
        popup_{{ loop.index }}
            .setLngLat(e.lngLat)
            .setHTML(`{{ popup.html }}`)
            .addTo(map);
    });
    {% endif %}
    {% endfor %}


    // Tile Layers
    var tileLayers = [
    {% for tile in tile_layers %}
        { id: "{{ tile.id }}", name: "{{ tile.name }}" },
    {% endfor %}
    ];

    var overlayGroups = [
    {% for name, layers in overlay_groups.items() %}
        { name: "{{ name }}", layers: {{ layers | tojson }} },
    {% endfor %}
    ];

    {% if tile_layers %}
    // Hide all but the first tile layer
    tileLayers.forEach(function(tl, idx) {
        map.setLayoutProperty(tl.id, 'visibility', idx === 0 ? 'visible' : 'none');
    });
    {% endif %}

    {% if layer_control %}
    // Simple layer control
    var layerControl = document.createElement('div');
    layerControl.id = 'layer-control';
    tileLayers.forEach(function(tl) {
        var link = document.createElement('a');
        link.href = '#';
        link.textContent = tl.name;
        link.addEventListener('click', function(e) {
            e.preventDefault();
            tileLayers.forEach(function(other) {
                map.setLayoutProperty(other.id, 'visibility', other.id === tl.id ? 'visible' : 'none');
            });
        });
        layerControl.appendChild(link);
    });

    overlayGroups.forEach(function(group) {
        var label = document.createElement('label');
        var input = document.createElement('input');
        input.type = 'checkbox';
        input.checked = true;
        input.addEventListener('change', function() {
            group.layers.forEach(function(layerId) {
                map.setLayoutProperty(layerId, 'visibility', input.checked ? 'visible' : 'none');
            });
        });
        label.appendChild(input);
        label.appendChild(document.createTextNode(' ' + group.name));
        layerControl.appendChild(label);
    });

    map.getContainer().appendChild(layerControl);
    {% endif %}
});

    {{ extra_js | safe }}
    </script>
</body>

</html>
